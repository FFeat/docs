# 创建、改进微服务 API 及协定并进行版本控制

> 微服务API是服务与客户端之间的协定。在不破坏api约定的前提下，我们可以独立改进微服务。
> 如果要改约定，将会影响客户端或api网关。

api定义的本质**取决于所使用的协议**。
*如：：如果使用的是消息传递协议（amqp），则api由消息类型构成。
如果使用的是http和RESTful服务，则api由url、请求和响应JSON格式构成*

## 需要版本控制的场景

服务的api基本上随着不断迭代会进行一定程度的改变，如果这个api是一个给多个客户端应用程序使用的公共API，那么通常不能强制所有客户端升级到最新的api协定。
通常需要逐步增减对新版服务的部署，所以要支持同时运行旧版和新版的服务协定。
因此就有了制定服务api版本控制的必要性。

如果api改动较小，*如给api增加了属性或者参数* 则使用较久的api的客户端应该切换到新版本。并且也能给缺省的参数添加默认值，多余的属性客户端也可以忽略掉。

如果是breaking change，不可能让客户端或其他服务立即升级到最新版本，
所以服务必须为旧版api提供一段时间的支持。
*如果是基于http的，可以在url或者http标头中加入api版本号。*
然后可以选择在同一服务实例内同时实现两个版本的服务，还是部署不同实例分别处理两个版本的api。这里可以使用中介器模式(如MediatR库)，将不同的实现版本分离到独立的处理程序中去。

如果是REST结构，可以使用[**超媒体**](https://www.infoq.com/articles/mark-baker-hypermedia/)作为最佳解决方案。
